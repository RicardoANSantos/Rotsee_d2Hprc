# ======================================================================
# Climate Scenario Sensitivity – Leaf Water Isotope Model (with uncertainty)
# ======================================================================
# DESCRIPTION
#   Forward-models leaf-water enrichment (Δ²H_LW) using a coupled
#   Craig–Gordon + Péclet model under different climate scenarios.
#
#   SCENARIOS (drivers):
#     A) RH-only        : RH 60 → 90 %, T fixed at modern mean (11 °C)
#     B) Temperature-only: T 10 → 16 °C, RH fixed at modern mean (76 %)
#     C) Covary:
#          Regime 1: RH 60→90, T 10→16   (RH↑, T↑)
#          Regime 2: RH 60→90, T 16→10   (RH↑, T↓)
#
#   VEGETATION TYPES (effective path length):
#     - Mixed forest     : 100 ± 10 mm
#     - Coniferous forest: 200 ± 50 mm
#
#   OUTPUT:
#     - Faceted 2 × 3 plot:
#         columns = drivers (RH-only, Temperature-only, RH–T covary)
#         rows    = climate regimes (RH↑,T↑ vs RH↑,T↓)
#     - Colour encodes temperature used for each simulation point.
#
# ======================================================================

# ---- Packages ---------------------------------------------------------
library(ggplot2)
library(dplyr)
library(tidyr)

# ---- Output directory -------------------------------------------------
# Set this to the folder where you want the figure saved
output_dir <- "."

# ---- User inputs (Rotsee-like modern state) ---------------------------
Elevation_m          <- 419 #Rotsee elevation (m)

Rel_hum_mean         <- 76.1 #Rotsee modern mean Relative Humidity (m)
Rel_hum_sd           <- 5

Air_temp_mean        <- 11
Air_temp_sd          <- 2

Sto_cond_mean        <- 0.2
Sto_cond_sd          <- 0.1

Bound_layer_res_mean <- 1
Bound_layer_res_sd   <- 0.1

d2H_XW_mean          <- -68
d2H_XW_sd            <- 10

n_iter               <- 10000
set.seed(123)

# ======================================================================
# FORWARD MODEL: Δ²H_LW (Craig–Gordon + Péclet)
# ======================================================================
calc_Delta2H_LW_scalar <- function(RH, Tair,
                                   Sto_cond, Bound_layer_res,
                                   Path_length, d2H_XW,
                                   Elevation_m = 419) {

  # Sanity bounds
  Sto_cond        <- max(Sto_cond,        1e-6)
  Bound_layer_res <- max(Bound_layer_res, 1e-6)
  Path_length     <- max(Path_length,     1e-6)

  # Atmospheric pressure (hPa)
  Atm_Pressure <- 1013 * exp(-Elevation_m / 7990)

  # Saturation vapour pressure (hPa)
  Sat_vp_air <- (1.0007 + 3.46 * Atm_Pressure / 1e6) *
    (6.1121 * exp(17.502 * Tair / (240.97 + Tair)))

  # Actual vapour pressure (hPa)
  Actual_vp_air <- (RH / 100) * Sat_vp_air

  # Leaf temperature (°C)
  Tleaf <- Tair

  # Resistances
  Sto_res <- 1 / Sto_cond

  # Leaf internal vapour pressure (hPa)
  Leaf_int_vp <- 6.13753 * exp(
    Tleaf * ((18.564 - (Tleaf / 254.4)) / (Tleaf + 255.57))
  )

  ea_ei <- Actual_vp_air / Leaf_int_vp

  # ε_kappa (‰)
  eps_kappa <- (25 * Sto_res + 17 * Bound_layer_res) /
    (Sto_res + Bound_layer_res)

  # ε+ (‰)
  eps_plus <- (exp((24.844 * 1000 / (273.16 + Tair)^2) -
                     (76.248 / (273.16 + Tair)) +
                     0.052612) - 1) * 1000

  # Transpiration rate (m² s/mol)
  Trans <- (((Leaf_int_vp / 10) - (Actual_vp_air / 10)) / 100) *
    ((1 / (Bound_layer_res + Sto_res)) * 1000)

  # Diffusivity in water (m²/s)
  Diffusivity_water <- 1e-8 * exp(
    -0.7 + 1729 / (Tleaf + 273) - 586977 / ((Tleaf + 273)^2)
  )

  # Water concentration (mol/m³)
  Water_conc <- 5.5555e4

  # Péclet number
  Peclet <- ((Path_length / 1000) * (Trans / 1000)) /
    (Water_conc * Diffusivity_water)

  # δ²H of water vapour (‰)
  d2H_WV <- (((d2H_XW / 1000 + 1) / (eps_plus / 1000 + 1)) - 1) * 1000

  # Δ²H of water vapour (‰)
  Delta2H_WV <- d2H_WV - d2H_XW

  # No-Péclet leaf-water enrichment, Δ²He (‰)
  Delta2He <- ((1 + eps_plus / 1000) *
                 ((1 + eps_kappa / 1000) * (1 - ea_ei) +
                    ea_ei * (1 + Delta2H_WV / 1000)) - 1) * 1000

  # Apply Péclet correction
  if (is.na(Peclet) || Peclet <= 1e-9) {
    Delta2H_LW <- Delta2He
  } else {
    Delta2H_LW <- (Delta2He * (1 - exp(-Peclet))) / Peclet
  }

  Delta2H_LW
}

# ======================================================================
# MONTE CARLO SIMULATOR FOR A SINGLE SCENARIO
# ======================================================================
simulate_scenario <- function(RH_fixed = NULL,
                              T_fixed  = NULL,
                              driver   = c("RH", "Temperature", "Covary"),
                              path_mean, path_sd,
                              n_iter   = 10000) {

  driver      <- match.arg(driver)
  Delta_vals  <- numeric(n_iter)

  for (i in seq_len(n_iter)) {

    # Define RH and T for this iteration
    if (driver == "RH") {
      RH   <- RH_fixed
      Tair <- Air_temp_mean
    } else if (driver == "Temperature") {
      Tair <- T_fixed
      RH   <- Rel_hum_mean
    } else if (driver == "Covary") {
      RH   <- RH_fixed
      Tair <- T_fixed
    }

    # Draw uncertain parameters
    Sto_cond_i <- rnorm(1, Sto_cond_mean,        Sto_cond_sd)
    Bound_i    <- rnorm(1, Bound_layer_res_mean, Bound_layer_res_sd)
    Path_i     <- rnorm(1, path_mean,            path_sd)
    d2H_XW_i   <- rnorm(1, d2H_XW_mean,          d2H_XW_sd)

    Delta_vals[i] <- calc_Delta2H_LW_scalar(
      RH              = RH,
      Tair            = Tair,
      Sto_cond        = Sto_cond_i,
      Bound_layer_res = Bound_i,
      Path_length     = Path_i,
      d2H_XW          = d2H_XW_i,
      Elevation_m     = Elevation_m
    )
  }

  tibble(
    Delta_mean = mean(Delta_vals, na.rm = TRUE),
    Delta_sd   = sd(Delta_vals,   na.rm = TRUE),
    Delta_p5   = quantile(Delta_vals, 0.05, na.rm = TRUE),
    Delta_p95  = quantile(Delta_vals, 0.95, na.rm = TRUE)
  )
}

# ======================================================================
# Scenario definitions
# ======================================================================
RH_seq <- seq(60, 90, by = 5)   # RH steps
T_seq  <- seq(10, 16, by = 1)   # T steps

# Covary regimes
Covary_same <- tibble(   # RH up, T up
  RH = seq(60, 90, length.out = 7),
  T  = seq(10, 16, length.out = 7)
)

Covary_opposite <- tibble(  # RH up, T down
  RH = seq(60, 90, length.out = 7),
  T  = seq(16, 10, length.out = 7)
)

# Helper to build scenarios for a given path-length regime & covary table
build_scenarios_for_regime <- function(path_mean, path_sd,
                                       physiology_label,
                                       climate_regime_label,
                                       covary_df) {

  # RH-only
  df_RH <- bind_rows(lapply(RH_seq, function(rh) {
    out <- simulate_scenario(
      RH_fixed  = rh,
      T_fixed   = NULL,
      driver    = "RH",
      path_mean = path_mean,
      path_sd   = path_sd,
      n_iter    = n_iter
    )

    out$Driver    <- "RH"
    out$X_value   <- rh
    out$Scenario  <- paste0("RH_", rh)
    out$RH_value  <- rh
    out$T_value   <- Air_temp_mean
    out
  }))

  # Temperature-only
  df_T <- bind_rows(lapply(T_seq, function(Tv) {
    out <- simulate_scenario(
      RH_fixed  = NULL,
      T_fixed   = Tv,
      driver    = "Temperature",
      path_mean = path_mean,
      path_sd   = path_sd,
      n_iter    = n_iter
    )

    out$Driver    <- "Temperature"
    out$X_value   <- Tv
    out$Scenario  <- paste0("T_", Tv)
    out$RH_value  <- Rel_hum_mean
    out$T_value   <- Tv
    out
  }))

  # Covary (x-axis = RH, colour encodes T)
  df_Co <- bind_rows(lapply(seq_len(nrow(covary_df)), function(i) {
    out <- simulate_scenario(
      RH_fixed  = covary_df$RH[i],
      T_fixed   = covary_df$T[i],
      driver    = "Covary",
      path_mean = path_mean,
      path_sd   = path_sd,
      n_iter    = n_iter
    )

    out$Driver    <- "Covary"
    out$X_value   <- covary_df$RH[i]
    out$Scenario  <- paste0("Co_RH", covary_df$RH[i], "_T", covary_df$T[i])
    out$RH_value  <- covary_df$RH[i]
    out$T_value   <- covary_df$T[i]
    out
  }))

  bind_rows(df_RH, df_T, df_Co) |>
    mutate(
      Physiology     = physiology_label,
      Climate_regime = climate_regime_label
    )
}

# ======================================================================
# Run simulations for both vegetation types & climate regimes
# ======================================================================
# Regime 1: RH ↑, T ↑
res_mixed_same <- build_scenarios_for_regime(
  path_mean            = 100,
  path_sd              = 10,
  physiology_label     = "Mixed forest (100 ± 10 mm)",
  climate_regime_label = "RH↑, T↑",
  covary_df            = Covary_same
)

res_conif_same <- build_scenarios_for_regime(
  path_mean            = 200,
  path_sd              = 50,
  physiology_label     = "Coniferous forest (200 ± 50 mm)",
  climate_regime_label = "RH↑, T↑",
  covary_df            = Covary_same
)

# Regime 2: RH ↑, T ↓
res_mixed_opp <- build_scenarios_for_regime(
  path_mean            = 100,
  path_sd              = 10,
  physiology_label     = "Mixed forest (100 ± 10 mm)",
  climate_regime_label = "RH↑, T↓",
  covary_df            = Covary_opposite
)

res_conif_opp <- build_scenarios_for_regime(
  path_mean            = 200,
  path_sd              = 50,
  physiology_label     = "Coniferous forest (200 ± 50 mm)",
  climate_regime_label = "RH↑, T↓",
  covary_df            = Covary_opposite
)

# Combine all simulations
all_res <- bind_rows(
  res_mixed_same, res_conif_same,
  res_mixed_opp,  res_conif_opp
)

# Factor ordering
all_res$Driver <- factor(all_res$Driver,
                         levels = c("RH", "Temperature", "Covary"))
all_res$Climate_regime <- factor(all_res$Climate_regime,
                                 levels = c("RH↑, T↑", "RH↑, T↓"))
all_res$Physiology <- factor(
  all_res$Physiology,
  levels = c(
    "Mixed forest (100 ± 10 mm)",
    "Coniferous forest (200 ± 50 mm)"
  )
)

# ======================================================================
# Plotting – 2 × 3 facet grid
#   - Colour = temperature used for each point
#   - x label is panel-specific (encoded in facet strip)
# ======================================================================
ylim_min <- 0
ylim_max <- 55
pd       <- position_dodge(width = 0.4)

p_sensitivity <- ggplot(
  all_res,
  aes(
    x      = X_value,
    y      = Delta_mean,
    colour = T_value,
    group  = Physiology,
    shape  = Physiology
  )
) +
  geom_errorbar(
    aes(ymin = Delta_p5, ymax = Delta_p95),
    position = pd,
    width    = 0.3,
    alpha    = 0.8
  ) +
  geom_point(size = 2.5, position = pd) +
  geom_line(linewidth = 0.9, position = pd) +
  scale_y_continuous(limits = c(ylim_max, ylim_min)) +
  scale_colour_gradient(name = "Temperature (°C)") +
  facet_grid(
    Climate_regime ~ Driver,
    scales   = "free_x",
    labeller = labeller(
      Driver = c(
        RH          = "RH-only\n(x = RH %)",
        Temperature = "Temperature-only\n(x = T °C)",
        Covary      = "RH–T covary\n(x = RH %)"
      )
    )
  ) +
  labs(
    title = "Climate Scenario Effects on Leaf-Water Enrichment (Δ²H_LW)",
    x     = NULL,
    y     = expression(Delta^2 * "H"[LW] * " (‰)"),
    shape = "Physiology"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    strip.text  = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

print(p_sensitivity)

# ---- Save figure ------------------------------------------------------
ggsave("LeafWater_ClimateScenarios_Mixed_vs_Coniferous.png",
       p_sensitivity, width = 11, height = 6, dpi = 300)

Cairo::CairoPDF("LeafWater_ClimateScenarios_Mixed_vs_Coniferous.pdf",
                width = 11, height = 6)
print(p_sensitivity)
dev.off()
